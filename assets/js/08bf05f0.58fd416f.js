"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[5428],{3023:(e,n,a)=>{a.d(n,{R:()=>i,x:()=>d});var t=a(3696);const s={},r=t.createContext(s);function i(e){const n=t.useContext(r);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),t.createElement(r.Provider,{value:n},e.children)}},5698:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>l,contentTitle:()=>d,default:()=>u,frontMatter:()=>i,metadata:()=>t,toc:()=>o});const t=JSON.parse('{"id":"database/orm-and-model","title":"ORM and Models","description":"The aim is to make accessing database easier and more friendly using objects.","source":"@site/docs/database/orm-and-model.md","sourceDirName":"database","slug":"/database/orm-and-model","permalink":"/pashmak/docs/database/orm-and-model","draft":false,"unlisted":false,"editUrl":"https://github.com/devbro1/pashmak/blob/master/docs/docs/database/orm-and-model.md","tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"sidebar_position":4},"sidebar":"tutorialSidebar","previous":{"title":"DB and SQL","permalink":"/pashmak/docs/database/db_sql"},"next":{"title":"ORM Relationships","permalink":"/pashmak/docs/database/orm-relationships"}}');var s=a(2540),r=a(3023);const i={sidebar_position:4},d="ORM and Models",l={},o=[{value:"Primary Key",id:"primary-key",level:2},{value:"Default Value",id:"default-value",level:2},{value:"guarded",id:"guarded",level:2},{value:"toJson()",id:"tojson",level:2},{value:"save()",id:"save",level:2},{value:"delete()",id:"delete",level:2},{value:"Model.create()",id:"modelcreate",level:2},{value:"table name",id:"table-name",level:2},{value:"creating a new model",id:"creating-a-new-model",level:2},{value:"Generally Available methods",id:"generally-available-methods",level:2},{value:"refresh()",id:"refresh",level:3},{value:"find() / findByPrimaryKey()",id:"find--findbyprimarykey",level:3},{value:"findOrFail()",id:"findorfail",level:3},{value:"findOne()",id:"findone",level:3},{value:"getQuery()",id:"getquery",level:3},{value:"fill()",id:"fill",level:3},{value:"isDirty()",id:"isdirty",level:3},{value:"<code>created_at</code> and <code>updated_at</code> timestamps",id:"created_at-and-updated_at-timestamps",level:3},{value:"Casters and Mutators",id:"casters-and-mutators",level:2},{value:"Scopes",id:"scopes",level:2},{value:"Global Scopes",id:"global-scopes",level:3},{value:"Local Scope",id:"local-scope",level:3},{value:"getLocalScopesQuery class",id:"getlocalscopesquery-class",level:3}];function c(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",mermaid:"mermaid",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"orm-and-models",children:"ORM and Models"})}),"\n",(0,s.jsx)(n.p,{children:"The aim is to make accessing database easier and more friendly using objects."}),"\n",(0,s.jsx)(n.p,{children:"to create a new model:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'import { BaseModel, Attribute } from "@devbro/pashmak/orm";\n\nexport class User extends BaseModel {\n  protected guarded: string[] = ["password"];\n\n  @Attribute({ primaryKey: true, incrementingPrimaryKey: true })\n  declare id: number;\n\n  @Attribute()\n  declare username: string;\n\n  @Attribute({\n    default: true,\n  })\n  declare active: boolean;\n\n  @Attribute()\n  declare password: string;\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:"every attribute that comes from database must get a @Attribute() decorator. It will tell the model what needs to be loaded or saved to database."}),"\n",(0,s.jsx)(n.h2,{id:"primary-key",children:"Primary Key"}),"\n",(0,s.jsxs)(n.p,{children:["every model will need a unique identified that you mark using ",(0,s.jsx)(n.code,{children:"primaryKey:true"}),". If the value of your primary key is auto-calculated in the database during insert, then ",(0,s.jsx)(n.code,{children:"incrementingPrimaryKey: true"})," will let model know to get the newly generated id after create."]}),"\n",(0,s.jsx)(n.h2,{id:"default-value",children:"Default Value"}),"\n",(0,s.jsx)(n.p,{children:"If you need to set default value for an attribute, you will need to do so through @Attribute decorator. If you assign default value directly, then expect unexpected behavior where default value overrides actual value during model constructor."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:'@Attribute({\n  default: "hello",\n})\ndeclare var1: string;\n\n@Attribute()\npublic var2: string = "bad"; // \u274c if you do this, then new Model({var2: "new_val" }) will not work\n'})}),"\n",(0,s.jsx)(n.h2,{id:"guarded",children:"guarded"}),"\n",(0,s.jsx)(n.p,{children:"if you want to mark a attribute as sensetive, you can use guarded to tell the model to not include it when we call toJson();"}),"\n",(0,s.jsx)(n.h2,{id:"tojson",children:"toJson()"}),"\n",(0,s.jsxs)(n.p,{children:["you can convert a model object to a json using ",(0,s.jsx)(n.code,{children:"toJson()"})," to send or save clean data."]}),"\n",(0,s.jsx)(n.h2,{id:"save",children:"save()"}),"\n",(0,s.jsx)(n.p,{children:"to save your data to database, if it is an object that was retrieved from database, then it will update database."}),"\n",(0,s.jsx)(n.h2,{id:"delete",children:"delete()"}),"\n",(0,s.jsx)(n.p,{children:"to delete the model from database. data still reside in the object."}),"\n",(0,s.jsx)(n.h2,{id:"modelcreate",children:"Model.create()"}),"\n",(0,s.jsx)(n.p,{children:"to Quickly create a new object that is saved to database"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:'let comment = await Comment.create<Comment>({\n  author: "Tiger Cat",\n  comment: "story of my life",\n});\n'})}),"\n",(0,s.jsx)(n.h2,{id:"table-name",children:"table name"}),"\n",(0,s.jsx)(n.p,{children:"table name is auto calculated as plural of the model name. so Country model will look rows from countries table."}),"\n",(0,s.jsx)(n.p,{children:"if you want to override the table name:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"protected tableName: string = 'mars_countries';\n"})}),"\n",(0,s.jsx)(n.h2,{id:"creating-a-new-model",children:"creating a new model"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"let user = new User();\nuser.fill({ username: 'meowadmin' });\n// or\nlet user = new User({ username: 'meowadmin' });\n"})}),"\n",(0,s.jsx)(n.p,{children:"only parameters marked with @attribute will be filled."}),"\n",(0,s.jsx)(n.h2,{id:"generally-available-methods",children:"Generally Available methods"}),"\n",(0,s.jsx)(n.h3,{id:"refresh",children:"refresh()"}),"\n",(0,s.jsx)(n.p,{children:"sometimes you need to reload data from database. you can do this by"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:'console.log(user.username); // meow\nuser.username = "newusername";\nconsole.log(user.username); // newusername\nawait user.refresh();\nconsole.log(user.username); // meow\n'})}),"\n",(0,s.jsx)(n.h3,{id:"find--findbyprimarykey",children:"find() / findByPrimaryKey()"}),"\n",(0,s.jsxs)(n.p,{children:["assuming you are using ",(0,s.jsx)(n.code,{children:"id"})," as your primary key, you can find objects by id"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"await User.find(123);\nawait User.findByPrimaryKey(123);\n"})}),"\n",(0,s.jsx)(n.p,{children:"if find fails, it will return undefined"}),"\n",(0,s.jsx)(n.h3,{id:"findorfail",children:"findOrFail()"}),"\n",(0,s.jsxs)(n.p,{children:["same as ",(0,s.jsx)(n.code,{children:"find()"})," but will throw an error on failure"]}),"\n",(0,s.jsx)(n.h3,{id:"findone",children:"findOne()"}),"\n",(0,s.jsx)(n.p,{children:"it will return the first object that matches the search matches you provide."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:'await USer.findOne({ username: "meowadmin" });\n'})}),"\n",(0,s.jsx)(n.p,{children:"note: the search parameters need to be exact match. they also can be anything defined in database but not in your model."}),"\n",(0,s.jsx)(n.h3,{id:"getquery",children:"getQuery()"}),"\n",(0,s.jsx)(n.p,{children:"returns a query object with table predefined"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"await User.getQuery();\n"})}),"\n",(0,s.jsx)(n.h3,{id:"fill",children:"fill()"}),"\n",(0,s.jsx)(n.p,{children:"to mass field parameters in a object"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:'user.fill({ email: "meow@devbro.com" });\n'})}),"\n",(0,s.jsx)(n.h3,{id:"isdirty",children:"isDirty()"}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"isDirty()"})," method checks if the model or specific attribute(s) have been modified since the last save. This is useful for tracking changes before persisting them to the database."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Usage:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:'// Check if any attribute has been modified\nif (user.isDirty()) {\n  console.log("User has unsaved changes");\n}\n\n// Check if a specific attribute has been modified\nif (user.isDirty("username")) {\n  console.log("Username has been changed");\n}\n\n// Check if any of multiple attributes have been modified\nif (user.isDirty(["email", "username"])) {\n  console.log("Either email or username has been changed");\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Parameters:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"attribute"})," (optional): Can be:","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"undefined"})," - checks if any attribute is dirty"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"string"})," - checks if a specific attribute is dirty"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"string[]"})," - checks if any of the specified attributes are dirty"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Returns:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"boolean"})," - ",(0,s.jsx)(n.code,{children:"true"})," if the specified attribute(s) have been modified, ",(0,s.jsx)(n.code,{children:"false"})," otherwise"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Example:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:'let user = await User.find(123);\nconsole.log(user.isDirty()); // false - no changes yet\n\nuser.username = "newusername";\nconsole.log(user.isDirty()); // true - has unsaved changes\nconsole.log(user.isDirty("username")); // true - username was changed\nconsole.log(user.isDirty("email")); // false - email was not changed\n\nawait user.save();\nconsole.log(user.isDirty()); // false - changes have been saved\n'})}),"\n",(0,s.jsxs)(n.h3,{id:"created_at-and-updated_at-timestamps",children:[(0,s.jsx)(n.code,{children:"created_at"})," and ",(0,s.jsx)(n.code,{children:"updated_at"})," timestamps"]}),"\n",(0,s.jsxs)(n.p,{children:["every model comes with standard ",(0,s.jsx)(n.code,{children:"created_at"})," and ",(0,s.jsx)(n.code,{children:"updated_at"})," fields. you can use these fields to track when they were created and updated last."]}),"\n",(0,s.jsx)(n.p,{children:"to modify standard behaviors you can define your models as such:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:'class Animal extends BaseModel {\n  protected hasTimestamps = true;\n  protected timestampFormat = "yyyy-MM-dd HH:mm:ss.SSS";\n  protected createdAtFieldName = "created_at";\n  protected updatedAtFieldName = "updated_at";\n\n  @Attribute()\n  declare created_at: Date;\n\n  @attribute()\n  declare updated_at: Date;\n}\n'})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"hasTimestamps: controls if class has time stamp fields or not. you can set to false if your model does not have these fields."}),"\n",(0,s.jsx)(n.li,{children:"timestampFormat: the format timestamp needs to be converted to in string before inserting to database."}),"\n",(0,s.jsx)(n.li,{children:"createdAtFieldName: the field name that will contain created_at date"}),"\n",(0,s.jsx)(n.li,{children:"updatedAtFeildName: the field name that contains updated_at date"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"these values are calculated automatically during save(). if save() is successfull created_at and updated_at will be adjust in the model."}),"\n",(0,s.jsx)(n.p,{children:"if you want to run save() without update timestamps then:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"await cat.save({ updateTimestamps: false });\n"})}),"\n",(0,s.jsx)(n.h2,{id:"casters-and-mutators",children:"Casters and Mutators"}),"\n",(0,s.jsx)(n.p,{children:"casters can be used to modify the field when we read it from database.\nmutators can be used to modify the data when we write it to database."}),"\n",(0,s.jsx)(n.mermaid,{value:"graph LR\n  Controller --\x3e Model\n  Model --\x3e|Caster| Database\n  Database --\x3e|Mutator| Model\n  Model --\x3e Controller"}),"\n",(0,s.jsx)(n.p,{children:"you can define casters and mutators for an attributes"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"@attributes({\n  caster: (val: Date) => val.toISOString(),\n  mutator: (val: string) => parseStringToDate(val),\n})\ndeclare date_of_birth: Date;\n"})}),"\n",(0,s.jsx)(n.h2,{id:"scopes",children:"Scopes"}),"\n",(0,s.jsx)(n.p,{children:"Scopes is the concept of adding extra limitations to queries used within ORM."}),"\n",(0,s.jsx)(n.p,{children:"There are two types of scopes you can use Global vs Local."}),"\n",(0,s.jsx)(n.h3,{id:"global-scopes",children:"Global Scopes"}),"\n",(0,s.jsx)(n.p,{children:"Global scopes are autoloaded by the model on every query request."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:'class Region2 extends GlobalScope {\n  public async apply(query: Query): Promise<Query> {\n    let region_id = ctx().get<User>("authenticated_user").region_id;\n    return query.whereOp("region_id", "=", region_id);\n  }\n}\n\nclass HasIinName extends GlobalScope {\n  public async apply(query: Query): Promise<Query> {\n    return query.whereOp("country_name", "ILIKE", "%I%");\n  }\n}\n\nclass Country2 extends BaseModel {\n  protected tableName: string = "countries";\n  protected hasTimestamps: boolean = false;\n  scopes = [Region2, HasIinName];\n\n  @Attribute({ primaryKey: true, incrementingPrimaryKey: false })\n  public country_id: number | undefined;\n\n  @Attribute()\n  public country_name: string | undefined;\n\n  @Attribute()\n  public region_id: number | undefined;\n\n  regions(): Region[] {\n    return [];\n  }\n}\n\nlet countries = await (await Country2.getQuery()).get();\n'})}),"\n",(0,s.jsx)(n.p,{children:"One advantage of GlobalScope is you can use one for multiple models.\nMain use case for globalScope is use with Authorization logic where you can limit\naccess to records before they are loaded from database."}),"\n",(0,s.jsx)(n.h3,{id:"local-scope",children:"Local Scope"}),"\n",(0,s.jsx)(n.p,{children:"There may be situations that you want easier to read queries OR your query logics are too complicated to rewrite in multiple places.\nso you can use a local scope to inject code into Query of a model"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:'class Country extends BaseModel {\n  protected tableName: string = "countries";\n  protected hasTimestamps: boolean = false;\n\n  @Attribute({ primaryKey: true, incrementingPrimaryKey: false })\n  public country_id: number | undefined;\n\n  @Attribute()\n  public country_name: string | undefined;\n\n  @Attribute()\n  public region_id: number | undefined;\n\n  regions(): Region[] {\n    return [];\n  }\n\n  public static getLocalScopesQuery() {\n    return class extends LocalScopeQuery<Country> {\n      protected getModel(): new () => Country {\n        return Country;\n      }\n\n      region(region_id: number) {\n        this.whereOp("region_id", "=", region_id);\n        return this;\n      }\n\n      nameLike(name: string) {\n        this.whereOp("country_name", "ILIKE", `%${name}%`);\n        return this;\n      }\n    };\n  }\n}\n\nlet result = await (await Country.getQuery())\n  .nameLike("united")\n  .region(2)\n  .get();\n'})}),"\n",(0,s.jsx)(n.h3,{id:"getlocalscopesquery-class",children:"getLocalScopesQuery class"}),"\n",(0,s.jsx)(n.p,{children:"this class added a few extra localscope functions that can help with casting."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"let c1_obj = await (await Country.getQuery()).region(1).getObject(); // return an object of type Country or undefined\n\nlet c1_objs = await (await Country.getQuery()).region(1).getObjects(); // return an array of type Country, or array will be empty if none match\n"})})]})}function u(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}}}]);