"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[444],{1380(e,n,a){a.r(n),a.d(n,{assets:()=>o,contentTitle:()=>r,default:()=>h,frontMatter:()=>l,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"database/db_migration","title":"Database Migrations","description":"Database migrations provide version control for your database schema, allowing you to track and manage changes to your database structure over time. They enable teams to synchronize database changes and provide a way to roll back changes when needed.","source":"@site/docs/database/db_migration.md","sourceDirName":"database","slug":"/database/db_migration","permalink":"/pashmak/docs/database/db_migration","draft":false,"unlisted":false,"editUrl":"https://github.com/devbro1/pashmak/blob/master/docs/docs/database/db_migration.md","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"sidebar_position":2},"sidebar":"tutorialSidebar","previous":{"title":"Setup Database","permalink":"/pashmak/docs/database/db_setup"},"next":{"title":"DB and SQL","permalink":"/pashmak/docs/database/db_sql"}}');var i=a(2540),s=a(3023);const l={sidebar_position:2},r="Database Migrations",o={},d=[{value:"Creating new migration files",id:"creating-new-migration-files",level:2},{value:"What are Migrations?",id:"what-are-migrations",level:2},{value:"Basic Migration Structure",id:"basic-migration-structure",level:3},{value:"Migration with Foreign Keys",id:"migration-with-foreign-keys",level:3},{value:"Alter Table Migration",id:"alter-table-migration",level:3},{value:"Creating Tables",id:"creating-tables",level:2},{value:"Basic Table",id:"basic-table",level:3},{value:"Column Types",id:"column-types",level:3},{value:"Column Modifiers",id:"column-modifiers",level:3},{value:"Primary Keys",id:"primary-keys",level:3},{value:"Foreign Keys",id:"foreign-keys",level:3},{value:"Indexes",id:"indexes",level:3},{value:"Modifying Tables",id:"modifying-tables",level:2},{value:"Add Columns",id:"add-columns",level:3},{value:"Drop Columns",id:"drop-columns",level:3},{value:"Add Indexes to Existing Table",id:"add-indexes-to-existing-table",level:3},{value:"Add Column with Index",id:"add-column-with-index",level:3},{value:"Dropping Tables",id:"dropping-tables",level:2},{value:"Table Information",id:"table-information",level:2},{value:"Refresh Migrations",id:"refresh-migrations",level:3},{value:"Fresh Migrations",id:"fresh-migrations",level:3},{value:"Migration Best Practices",id:"migration-best-practices",level:2}];function c(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"database-migrations",children:"Database Migrations"})}),"\n",(0,i.jsx)(n.p,{children:"Database migrations provide version control for your database schema, allowing you to track and manage changes to your database structure over time. They enable teams to synchronize database changes and provide a way to roll back changes when needed."}),"\n",(0,i.jsx)(n.h2,{id:"creating-new-migration-files",children:"Creating new migration files"}),"\n",(0,i.jsx)(n.p,{children:"To create new migration file run this command:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"npm run pdev generate migration new_migration_filename\n"})}),"\n",(0,i.jsxs)(n.p,{children:["This will create a new migraiton file ",(0,i.jsx)(n.code,{children:"src/database/migrations/DATE_MICROTIME_new_migration_filename.ts"})]}),"\n",(0,i.jsx)(n.h2,{id:"what-are-migrations",children:"What are Migrations?"}),"\n",(0,i.jsx)(n.p,{children:"Migrations are classes that define changes to be made to your database schema. Each migration has:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["An ",(0,i.jsx)(n.code,{children:"up()"})," method that applies the changes"]}),"\n",(0,i.jsxs)(n.li,{children:["A ",(0,i.jsx)(n.code,{children:"down()"})," method that reverts the changes"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"basic-migration-structure",children:"Basic Migration Structure"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:'import { Migration, Schema } from "@devbro/neko-sql";\n\nexport class CreateUsersTable extends Migration {\n  async up(schema: Schema): Promise<void> {\n    await schema.createTable("users", (table) => {\n      table.id();\n      table.timestamps();\n      table.string("name");\n      table.string("email").unique();\n      table.boolean("active").default(true);\n    });\n  }\n\n  async down(schema: Schema): Promise<void> {\n    await schema.dropTable("users");\n  }\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"migration-with-foreign-keys",children:"Migration with Foreign Keys"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:'export class CreatePostsTable extends Migration {\n  async up(schema: Schema): Promise<void> {\n    await schema.createTable("posts", (table) => {\n      table.id();\n      table.timestamps();\n      table.string("title");\n      table.text("content");\n      table.integer("user_id");\n      table.boolean("published").default(false);\n\n      table.foreign("user_id").references("id").on("users").onDelete("cascade");\n\n      table.index("user_id");\n      table.index("published");\n    });\n  }\n\n  async down(schema: Schema): Promise<void> {\n    await schema.dropTable("posts");\n  }\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"alter-table-migration",children:"Alter Table Migration"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:'export class AddPhoneToUsers extends Migration {\n  async up(schema: Schema): Promise<void> {\n    await schema.alterTable("users", (table) => {\n      table.string("phone_number", 20).nullable();\n      table.index("phone_number");\n    });\n  }\n\n  async down(schema: Schema): Promise<void> {\n    await schema.alterTable("users", (table) => {\n      table.dropColumn("phone_number");\n    });\n  }\n}\n'})}),"\n",(0,i.jsx)(n.h2,{id:"creating-tables",children:"Creating Tables"}),"\n",(0,i.jsx)(n.h3,{id:"basic-table",children:"Basic Table"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:'await schema.createTable("users", (table) => {\n  table.id(); // Auto-increment primary key\n  table.timestamps(); // created_at and updated_at\n  table.string("name");\n  table.string("email").unique();\n  table.boolean("active").default(true);\n});\n'})}),"\n",(0,i.jsx)(n.h3,{id:"column-types",children:"Column Types"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:'await schema.createTable("products", (table) => {\n  // Auto-increment ID\n  table.id();\n\n  // String types\n  table.string("name", 255); // VARCHAR(255)\n  table.text("description"); // TEXT\n  table.char("code"); // CHAR\n\n  // Numeric types\n  table.integer("quantity"); // INTEGER\n  table.float("price"); // FLOAT\n  table.double("weight"); // DOUBLE PRECISION\n\n  // Boolean\n  table.boolean("in_stock"); // BOOLEAN\n\n  // Date/Time\n  table.date("manufactured_date"); // DATE\n  table.timestamp("sold_at"); // TIMESTAMP\n  table.timestampTz("delivered_at"); // TIMESTAMP WITH TIME ZONE\n  table.datetime("checked_at"); // Alias for timestamp\n  table.datetimeTz("verified_at"); // Alias for timestampTz\n\n  // JSON\n  table.json("metadata"); // JSON\n  table.jsonb("settings"); // JSONB (PostgreSQL)\n\n  // Timestamps\n  table.timestamps(); // created_at, updated_at\n\n  // raw, whatever custom column you want to create\n  table.raw("area GEOGRAPHY(POLYGON, 4326)");\n});\n'})}),"\n",(0,i.jsx)(n.h3,{id:"column-modifiers",children:"Column Modifiers"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:'await schema.createTable("posts", (table) => {\n  table.id();\n\n  // Nullable column\n  table.string("subtitle").nullable();\n\n  // NOT NULL (default)\n  table.string("title"); // NOT NULL by default\n\n  // Default value\n  table.integer("views").default(0);\n  table.boolean("published").default(false);\n  table.string("status").default("draft");\n\n  // Unique constraint\n  table.string("slug").unique();\n\n  // Multiple modifiers\n  table.string("email").length(200).unique().nullable(false);\n});\n'})}),"\n",(0,i.jsx)(n.h3,{id:"primary-keys",children:"Primary Keys"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:'await schema.createTable("composite_keys", (table) => {\n  table.integer("user_id");\n  table.integer("role_id");\n\n  // Composite primary key\n  table.primary(["user_id", "role_id"]);\n});\n'})}),"\n",(0,i.jsx)(n.h3,{id:"foreign-keys",children:"Foreign Keys"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:'await schema.createTable("posts", (table) => {\n  table.id();\n  table.integer("user_id");\n  table.integer("category_id");\n\n  // Foreign key with cascade\n  table\n    .foreign("user_id")\n    .references("id")\n    .on("users")\n    .onDelete("cascade")\n    .onUpdate("cascade");\n\n  // Foreign key with restrict\n  table\n    .foreign("category_id")\n    .references("id")\n    .on("categories")\n    .onDelete("restrict")\n    .onUpdate("restrict");\n});\n\n// onDelete/onUpdate options:\n// - \'cascade\': Delete/update child records\n// - \'set null\': Set child column to NULL\n// - \'restrict\': Prevent deletion/update\n// - \'no action\': Similar to restrict\n'})}),"\n",(0,i.jsx)(n.h3,{id:"indexes",children:"Indexes"}),"\n",(0,i.jsx)(n.p,{children:"You can add indexes to your tables for better query performance:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:'await schema.createTable("articles", (table) => {\n  table.id();\n  table.string("title");\n  table.string("slug");\n  table.text("content");\n  table.string("author");\n  table.string("category");\n\n  // Basic index\n  table.index("title");\n\n  // Named index\n  table.index("slug", "idx_article_slug");\n\n  // Unique index\n  table.unique("slug");\n\n  // Composite index\n  table.index(["author", "category"]);\n\n  // Index with custom type\n  table.index("content").type("gin"); // For PostgreSQL full-text search\n\n  // Multiple indexes\n  table.index("author");\n  table.index("category");\n  table.unique(["author", "slug"]);\n});\n\n// Index types (PostgreSQL):\n// - \'btree\': Default, good for equality and range queries\n// - \'hash\': For equality comparisons\n// - \'gin\': For full-text search, JSONB\n// - \'gist\': For geometric data\n// - \'spgist\': Space-partitioned GiST\n// - \'brin\': Block Range INdexes\n'})}),"\n",(0,i.jsx)(n.h2,{id:"modifying-tables",children:"Modifying Tables"}),"\n",(0,i.jsx)(n.h3,{id:"add-columns",children:"Add Columns"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:'await schema.alterTable("users", (table) => {\n  table.string("phone_number").nullable();\n  table.date("birth_date");\n  table.text("bio");\n});\n'})}),"\n",(0,i.jsx)(n.h3,{id:"drop-columns",children:"Drop Columns"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:'await schema.alterTable("users", (table) => {\n  table.dropColumn("temporary_field");\n  table.dropColumn("old_column");\n});\n'})}),"\n",(0,i.jsx)(n.h3,{id:"add-indexes-to-existing-table",children:"Add Indexes to Existing Table"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:'await schema.alterTable("users", (table) => {\n  table.index("email");\n  table.index(["first_name", "last_name"], "idx_full_name");\n});\n'})}),"\n",(0,i.jsx)(n.h3,{id:"add-column-with-index",children:"Add Column with Index"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:'await schema.alterTable("posts", (table) => {\n  table.string("slug").unique();\n  table.index("slug"); // Separate index on the same column\n});\n'})}),"\n",(0,i.jsx)(n.h2,{id:"dropping-tables",children:"Dropping Tables"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:'// Drop table\nawait schema.dropTable("old_table");\n\n// Drop table if exists\nawait schema.dropTableIfExists("temp_table");\n'})}),"\n",(0,i.jsx)(n.h2,{id:"table-information",children:"Table Information"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:'// Get all tables\nconst tables = await schema.tables();\nconsole.log(tables);\n\n// Check if table exists\nconst exists = await schema.tableExists("users");\nconsole.log(exists); // true or false\n'})}),"\n",(0,i.jsx)(n.h3,{id:"refresh-migrations",children:"Refresh Migrations"}),"\n",(0,i.jsx)(n.p,{children:"Clean up the database by undoing all migrations, then reapply all available migrations:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"npm run pdev migrate --refresh\n"})}),"\n",(0,i.jsx)(n.h3,{id:"fresh-migrations",children:"Fresh Migrations"}),"\n",(0,i.jsx)(n.p,{children:"Drop and recreate the database, then run all migrations (use with caution as this is not recoverable!):"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"npm run pdev migrate --fresh\n"})}),"\n",(0,i.jsx)(n.h2,{id:"migration-best-practices",children:"Migration Best Practices"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Always Write Down Methods:"})," Every migration should have a corresponding down method that can undo the changes:"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Use Descriptive Migration Names:"})," it will help when you want to find relevant migration."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Handle Foreign Key Dependencies:"})," When creating tables with foreign keys, ensure the referenced tables exist."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Use Transactions for Multiple Operations and carefully:"})," If you have multiple operations in the same migration file, it can be helpful to use transactions in case of failure. Otherwise, in cases of partial migration, you will need to manually undo the changes."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Test Your Migrations:"})," Always test both up and down methods."]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},3023(e,n,a){a.d(n,{R:()=>l,x:()=>r});var t=a(3696);const i={},s=t.createContext(i);function l(e){const n=t.useContext(s);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:l(e.components),t.createElement(s.Provider,{value:n},e.children)}}}]);