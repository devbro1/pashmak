"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[5803],{2491(e,n,r){r.d(n,{A:()=>o});r(3696);var s=r(1750);const a="tabItem_wHwb";var t=r(2540);function o({children:e,hidden:n,className:r}){return(0,t.jsx)("div",{role:"tabpanel",className:(0,s.A)(a,r),hidden:n,children:e})}},2718(e,n,r){r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>l,default:()=>m,frontMatter:()=>u,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"going-deeper/queue","title":"Queue and Messaging","description":"The concept of the queue is to allow messages to be sent using connections an queue.","source":"@site/docs/going-deeper/queue.md","sourceDirName":"going-deeper","slug":"/going-deeper/queue","permalink":"/pashmak/docs/going-deeper/queue","draft":false,"unlisted":false,"editUrl":"https://github.com/devbro1/pashmak/blob/master/docs/docs/going-deeper/queue.md","tags":[],"version":"current","sidebarPosition":8,"frontMatter":{"sidebar_position":8},"sidebar":"tutorialSidebar","previous":{"title":"Middleware","permalink":"/pashmak/docs/going-deeper/middlewares"},"next":{"title":"Scheduler and Cron Jobs","permalink":"/pashmak/docs/going-deeper/scheduler"}}');var a=r(2540),t=r(3023),o=r(8296),i=r(2491);const u={sidebar_position:8},l="Queue and Messaging",c={},d=[{value:"connection vs queue",id:"connection-vs-queue",level:2},{value:"Configuration",id:"configuration",level:2},{value:"How messaging works",id:"how-messaging-works",level:2},{value:"Available drivers:",id:"available-drivers",level:2},{value:"Database",id:"database",level:4},{value:"Memory (In-Memory)",id:"memory-in-memory",level:4},{value:"Async Transport",id:"async-transport",level:4},{value:"SQS (Amazon Simple Queue Service)",id:"sqs-amazon-simple-queue-service",level:4},{value:"AMQP (RabbitMQ, BullMQ)",id:"amqp-rabbitmq-bullmq",level:4},{value:"Redis",id:"redis",level:4},{value:"Google Cloud Pub/Sub",id:"google-cloud-pubsub",level:4},{value:"Azure Service Bus",id:"azure-service-bus",level:4},{value:"Registering your own Provider",id:"registering-your-own-provider",level:2},{value:"Creating your own Transport",id:"creating-your-own-transport",level:2}];function p(e){const n={code:"code",h1:"h1",h2:"h2",h4:"h4",header:"header",p:"p",pre:"pre",...(0,t.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"queue-and-messaging",children:"Queue and Messaging"})}),"\n",(0,a.jsx)(n.p,{children:"The concept of the queue is to allow messages to be sent using connections an queue."}),"\n",(0,a.jsx)(n.h2,{id:"connection-vs-queue",children:"connection vs queue"}),"\n",(0,a.jsx)(n.p,{children:"concept of Connection is like a server/service that can handle multiple queues. Think of RabbitMQ server that can handle multiple queues."}),"\n",(0,a.jsx)(n.p,{children:"queue is a channel inside a connection that can handle messages."}),"\n",(0,a.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-ts",children:'// app/config/queues.ts\nexport default {\n  queues: {\n    default: {\n      type: "database",\n    },\n  },\n};\n'})}),"\n",(0,a.jsx)(n.h2,{id:"how-messaging-works",children:"How messaging works"}),"\n",(0,a.jsx)(n.p,{children:"unlike traditional approaches where you send string. Pashmak Queue works with objects:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-ts",children:"import { queue } from '@devbro/pashmak/facades';\nimport { QueueMessageInterface } from '@devbro/pashmak/queue';\n\nexport class IncomingWebhookMessage implements QueueMessageInterface {\n\n  /**\n   * Method to convert Message to string.\n   * keep in mind this string should be able to be converted back to Message object.\n   */\n  async getMessage(): Promise<string> {\n    return JSON.stringify({...this.something, ...this.somethingElse});\n  }\n\n    /**\n     * Method to set message from string or object.\n     */\n  async setMessage(value: string | Record<string, any>): Promise<void> {\n    ???\n    this.something = ???;\n    this.somethingElse = ???;\n  }\n\n/**\n * Method to validate message before processing.\n * return true if message is valid, false otherwise.\n * It is to prevent processing invalid messages.\n */\n  async validateMessage(): Promise<Boolean> {\n    return true;\n  }\n\n  async processMessage(): Promise<void> {\n    // process the message here\n  }\n\n    /**\n     * Send the message to a queue.\n     */\n  async dispatch() {\n    queue().dispatch('stripe_incoming_webhook', this);\n  }\n}\n"})}),"\n",(0,a.jsx)(n.h2,{id:"available-drivers",children:"Available drivers:"}),"\n",(0,a.jsx)(n.h4,{id:"database",children:"Database"}),"\n",(0,a.jsx)(n.p,{children:"Uses database to store messages. This is the default driver and requires a table in your database."}),"\n","\n",(0,a.jsxs)(o.A,{groupId:"package-manager",children:[(0,a.jsx)(i.A,{value:"npm",label:"npm",default:!0,children:(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"# Create a migration for queue table\npashmak generate queue migration\n# Then run migrations\npashmak migrate\n"})})}),(0,a.jsx)(i.A,{value:"yarn",label:"Yarn",children:(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"# Create a migration for queue table\npashmak generate queue migration\n# Then run migrations\npashmak migrate\n"})})}),(0,a.jsx)(i.A,{value:"pnpm",label:"pnpm",children:(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"# Create a migration for queue table\npashmak generate queue migration\n# Then run migrations\npashmak migrate\n"})})})]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-ts",children:"// app/config/queues.ts\nimport { DatabaseTransportConfig } from '@devbro/pashmak/queue';\n\nexport default {\n    default: {\n      provider: \"database\",\n      config: {\n        ???\n      } as DatabaseTransportConfig,\n    },\n};\n"})}),"\n",(0,a.jsx)(n.h4,{id:"memory-in-memory",children:"Memory (In-Memory)"}),"\n",(0,a.jsx)(n.p,{children:"The memory transport stores messages in memory and is ideal for development, testing, or simple applications that don't require persistence."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-ts",children:'// app/config/queues.ts\nexport default {\n  queues: {\n    default: {\n      provider: "memory",\n      config: {\n        interval: 10_000, // Interval to check for new messages (ms)\n      },\n    },\n  },\n};\n'})}),"\n",(0,a.jsx)(n.h4,{id:"async-transport",children:"Async Transport"}),"\n",(0,a.jsx)(n.p,{children:"The async transport processes messages asynchronously within the application, allowing for non-blocking operations and improved performance. Unlike memory transport, it will execute messages right away without waiting for an interval. Ideal for testing and development."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-ts",children:"// app/config/queues.ts\nimport { AsyncTransportConfig } from '@devbro/pashmak/queue';\n\nexport default {\n    default: {\n      provider: \"async\",\n      config: {\n        ???\n      } as AsyncTransportConfig,\n    },\n};\n"})}),"\n",(0,a.jsx)(n.h4,{id:"sqs-amazon-simple-queue-service",children:"SQS (Amazon Simple Queue Service)"}),"\n",(0,a.jsx)(n.p,{children:"Uses AWS SQS service for reliable, scalable message queuing. Requires AWS credentials and proper IAM permissions."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-ts",children:"// app/config/queues.ts\nimport { AwsSqsTransportConfig } from '@devbro/pashmak/queue';\n\nexport default {\n    default: {\n      provider: \"sqs\",\n      config: {\n        ???\n      } as AwsSqsTransportConfig,\n    },\n};\n"})}),"\n",(0,a.jsx)(n.h4,{id:"amqp-rabbitmq-bullmq",children:"AMQP (RabbitMQ, BullMQ)"}),"\n",(0,a.jsx)(n.p,{children:"Uses AMQP protocol to connect to RabbitMQ or other AMQP-compatible message brokers. Provides advanced routing and exchange patterns."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-ts",children:"// app/config/queues.ts\nimport { AmqpTransportConfig } from '@devbro/pashmak/queue';\n\nexport default {\n    default: {\n      provider: \"amqp\",\n      config: {\n        ???\n      } as AmqpTransportConfig,\n    },\n};\n"})}),"\n",(0,a.jsx)(n.h4,{id:"redis",children:"Redis"}),"\n",(0,a.jsx)(n.p,{children:"Uses Redis lists and pub/sub for fast, lightweight message queuing with optional retry and dead-letter queue support."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-ts",children:"// app/config/queues.ts\nimport { RedisTransportConfig } from '@devbro/pashmak/queue';\n\nexport default {\n    default: {\n      provider: \"redis\",\n      config: {\n        ???\n      } as RedisTransportConfig,\n    },\n};\n"})}),"\n",(0,a.jsx)(n.h4,{id:"google-cloud-pubsub",children:"Google Cloud Pub/Sub"}),"\n",(0,a.jsx)(n.p,{children:"Uses Google Cloud Pub/Sub for globally distributed message queuing with automatic scaling and high availability."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-ts",children:"// app/config/queues.ts\nimport { GooglePubSubTransportConfig } from '@devbro/pashmak/queue';\n\nexport default {\n    default: {\n      type: \"pubsub\",\n      config: {\n        ???\n      } as GooglePubSubTransportConfig,\n    },\n};\n"})}),"\n",(0,a.jsx)(n.h4,{id:"azure-service-bus",children:"Azure Service Bus"}),"\n",(0,a.jsx)(n.p,{children:"Uses Azure Service Bus for enterprise-grade message queuing with advanced features like sessions, transactions, and message scheduling."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-ts",children:"// app/config/queues.ts\nimport { AzureServiceBusTransportConfig } from '@devbro/pashmak/queue';\n\nexport default {\n  default: {\n    provider: \"azure_service_bus\",\n    config: {\n      ???\n    } as AzureServiceBusTransportConfig,\n  },\n};\n"})}),"\n",(0,a.jsx)(n.h2,{id:"registering-your-own-provider",children:"Registering your own Provider"}),"\n",(0,a.jsxs)(n.p,{children:["You can create custom queue transports by implementing the ",(0,a.jsx)(n.code,{children:"QueueTransportInterface"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-ts",children:'import { QueueTransportInterface } from "@devbro/pashmak/queue";\n\nexport class CustomTransport implements QueueTransportInterface {\n  /**\n   * Dispatch a message to a specific channel\n   */\n  async dispatch(channel: string, message: string): Promise<void> {\n    // Your implementation\n  }\n\n  /**\n   * Register a listener callback for a channel\n   */\n  async registerListener(\n    channel: string,\n    callback: (message: string) => Promise<void>,\n  ): Promise<void> {\n    // Your implementation\n  }\n\n  /**\n   * Start listening for messages on all registered channels\n   */\n  async startListening(): Promise<void> {\n    // Your implementation\n  }\n\n  /**\n   * Stop listening and cleanup resources\n   */\n  async stopListening(): Promise<void> {\n    // Your implementation\n  }\n}\n'})}),"\n",(0,a.jsx)(n.p,{children:"Then register your custom transport in the queue factory:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-ts",children:'import { QueueTransportFactory } from "@devbro/pashmak/queue";\nimport { CustomTransport } from "./CustomTransport";\n\n// Register your transport\nQueueTransportFactory.register("custom", (config) => {\n  return new CustomTransport(config);\n});\n\n// Use it in your config\nexport default {\n  queues: {\n    default: {\n      type: "custom",\n      // Your custom configuration\n    },\n  },\n};\n'})}),"\n",(0,a.jsx)(n.h2,{id:"creating-your-own-transport",children:"Creating your own Transport"}),"\n",(0,a.jsxs)(n.p,{children:["You can create custom queue transports by implementing the ",(0,a.jsx)(n.code,{children:"QueueTransportInterface"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-ts",children:'import { QueueTransportInterface } from "@devbro/pashmak/queue";\n\nexport class CustomTransport implements QueueTransportInterface {\n  /**\n   * Dispatch a message to a specific channel\n   */\n  async dispatch(channel: string, message: string): Promise<void> {\n    // Your implementation\n  }\n\n  /**\n   * Register a listener callback for a channel\n   */\n  async registerListener(\n    channel: string,\n    callback: (message: string) => Promise<void>,\n  ): Promise<void> {\n    // Your implementation\n  }\n\n  /**\n   * Start listening for messages on all registered channels\n   */\n  async startListening(): Promise<void> {\n    // Your implementation\n  }\n\n  /**\n   * Stop listening and cleanup resources\n   */\n  async stopListening(): Promise<void> {\n    // Your implementation\n  }\n}\n'})}),"\n",(0,a.jsx)(n.p,{children:"Then register your custom transport in the queue factory:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-ts",children:'import { QueueTransportFactory } from "@devbro/pashmak/queue";\nimport { CustomTransport } from "./CustomTransport";\n\n// Register your transport\nQueueTransportFactory.register("custom", (config) => {\n  return new CustomTransport(config);\n});\n'})}),"\n",(0,a.jsx)(n.p,{children:"and refer to it in your configuration:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-ts",children:'export default {\n  default: {\n    provider: "custom",\n    config: {\n      // Your custom configuration\n    },\n  },\n};\n'})})]})}function m(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(p,{...e})}):p(e)}},3023(e,n,r){r.d(n,{R:()=>o,x:()=>i});var s=r(3696);const a={},t=s.createContext(a);function o(e){const n=s.useContext(t);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:o(e.components),s.createElement(t.Provider,{value:n},e.children)}},8296(e,n,r){r.d(n,{A:()=>w});var s=r(3696),a=r(1750),t=r(3237),o=r(766),i=r(9519),u=r(4395),l=r(5043),c=r(4544),d=r(7454);function p(e){return s.Children.toArray(e).filter(e=>"\n"!==e).map(e=>{if(!e||(0,s.isValidElement)(e)&&function(e){const{props:n}=e;return!!n&&"object"==typeof n&&"value"in n}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)})?.filter(Boolean)??[]}function m(e){const{values:n,children:r}=e;return(0,s.useMemo)(()=>{const e=n??function(e){return p(e).map(({props:{value:e,label:n,attributes:r,default:s}})=>({value:e,label:n,attributes:r,default:s}))}(r);return function(e){const n=(0,c.XI)(e,(e,n)=>e.value===n.value);if(n.length>0)throw new Error(`Docusaurus error: Duplicate values "${n.map(e=>e.value).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e},[n,r])}function g({value:e,tabValues:n}){return n.some(n=>n.value===e)}function h({queryString:e=!1,groupId:n}){const r=(0,i.W6)(),a=function({queryString:e=!1,groupId:n}){if("string"==typeof e)return e;if(!1===e)return null;if(!0===e&&!n)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return n??null}({queryString:e,groupId:n});return[(0,l.aZ)(a),(0,s.useCallback)(e=>{if(!a)return;const n=new URLSearchParams(r.location.search);n.set(a,e),r.replace({...r.location,search:n.toString()})},[a,r])]}function f(e){const{defaultValue:n,queryString:r=!1,groupId:a}=e,t=m(e),[o,i]=(0,s.useState)(()=>function({defaultValue:e,tabValues:n}){if(0===n.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(e){if(!g({value:e,tabValues:n}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${e}" but none of its children has the corresponding value. Available values are: ${n.map(e=>e.value).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return e}const r=n.find(e=>e.default)??n[0];if(!r)throw new Error("Unexpected error: 0 tabValues");return r.value}({defaultValue:n,tabValues:t})),[l,c]=h({queryString:r,groupId:a}),[p,f]=function({groupId:e}){const n=function(e){return e?`docusaurus.tab.${e}`:null}(e),[r,a]=(0,d.Dv)(n);return[r,(0,s.useCallback)(e=>{n&&a.set(e)},[n,a])]}({groupId:a}),b=(()=>{const e=l??p;return g({value:e,tabValues:t})?e:null})();(0,u.A)(()=>{b&&i(b)},[b]);return{selectedValue:o,selectValue:(0,s.useCallback)(e=>{if(!g({value:e,tabValues:t}))throw new Error(`Can't select invalid tab value=${e}`);i(e),c(e),f(e)},[c,f,t]),tabValues:t}}var b=r(6681);const v="tabList_J5MA",x="tabItem_l0OV";var y=r(2540);function j({className:e,block:n,selectedValue:r,selectValue:s,tabValues:t}){const i=[],{blockElementScrollPositionUntilNextRender:u}=(0,o.a_)(),l=e=>{const n=e.currentTarget,a=i.indexOf(n),o=t[a].value;o!==r&&(u(n),s(o))},c=e=>{let n=null;switch(e.key){case"Enter":l(e);break;case"ArrowRight":{const r=i.indexOf(e.currentTarget)+1;n=i[r]??i[0];break}case"ArrowLeft":{const r=i.indexOf(e.currentTarget)-1;n=i[r]??i[i.length-1];break}}n?.focus()};return(0,y.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,a.A)("tabs",{"tabs--block":n},e),children:t.map(({value:e,label:n,attributes:s})=>(0,y.jsx)("li",{role:"tab",tabIndex:r===e?0:-1,"aria-selected":r===e,ref:e=>{i.push(e)},onKeyDown:c,onClick:l,...s,className:(0,a.A)("tabs__item",x,s?.className,{"tabs__item--active":r===e}),children:n??e},e))})}function q({lazy:e,children:n,selectedValue:r}){const t=(Array.isArray(n)?n:[n]).filter(Boolean);if(e){const e=t.find(e=>e.props.value===r);return e?(0,s.cloneElement)(e,{className:(0,a.A)("margin-top--md",e.props.className)}):null}return(0,y.jsx)("div",{className:"margin-top--md",children:t.map((e,n)=>(0,s.cloneElement)(e,{key:n,hidden:e.props.value!==r}))})}function k(e){const n=f(e);return(0,y.jsxs)("div",{className:(0,a.A)(t.G.tabs.container,"tabs-container",v),children:[(0,y.jsx)(j,{...n,...e}),(0,y.jsx)(q,{...n,...e})]})}function w(e){const n=(0,b.A)();return(0,y.jsx)(k,{...e,children:p(e.children)},String(n))}}}]);